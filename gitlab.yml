version: '3.6'

services:

  gitlab:
    container_name: gitlab
    image: gitlab/gitlab-ee:latest
    restart: always
    env_file: ./.env
    hostname: ${HOST}:${GITLAB_HTTP_PORT}
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        gitlab_rails['gitlab_shell_ssh_port'] = ${GITLAB_SSH_PORT}
    ports:
      - ${GITLAB_SSH_PORT}:22
      - ${GITLAB_HTTP_PORT}:${GITLAB_HTTP_PORT}
      - ${GITLAB_HTTPS_PORT}:443
    volumes:
      - ${GITLAB_HOME}/config:/etc/gitlab
      - ${GITLAB_HOME}/logs:/var/log/gitlab
      - ${GITLAB_HOME}/data:/var/opt/gitlab

  gitlab-runner:
    depends_on: 
      - gitlab
    container_name: runner
    image: gitlab/gitlab-runner:alpine
    volumes:
      - /srv/gitlab-runner/config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock

  docker-registry:
    container_name: docker-registry
    image: registry:2
    env_file: ./.env
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /data
    volumes:
      - ${DOCKER_REGISTRY_HOME}/data:/data
      - ./certificados/default_server:/certs
    restart: always
    ports:
      - ${DOCKER_REGISTRY_PORT}:5000
    expose: 
      - 5000
  
 